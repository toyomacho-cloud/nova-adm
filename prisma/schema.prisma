// This is your Prisma schema file for multi-tenant architecture

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// EXCHANGE RATES (BCV)
// ============================================

model ExchangeRate {
  id          String   @id @default(cuid())
  currency    String   // "USD", "EUR"
  rate        Float    // 36.50
  source      String   @default("BCV")
  date        DateTime @default(now())
  createdAt   DateTime @default(now())
  
  @@index([currency, date])
}

// ============================================
// MULTI-TENANT & AUTH
// ============================================

model Company {
  id          String   @id @default(cuid())
  name        String
  rif         String   @unique // RIF (Registro de Información Fiscal)
  address     String?
  phone       String?
  email       String?
  logo        String?
  isActive    Boolean  @default(true)
  
  // Special taxpayer status
  isSpecialTaxpayer Boolean @default(false)
  specialTaxpayerCode String?
  
  // Tax configuration
  ivaRate     Float    @default(16.0) // Venezuelan IVA rate
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  users            User[]
  customers        Customer[]
  vendors          Vendor[]
  products         Product[]
  paymentMethods   PaymentMethod[]
  cashRegisters    CashRegister[]
  sales            Sale[]
  purchases        Purchase[]
  ivaWithholdings  IVAWithholding[]
  islrWithholdings ISLRWithholding[]
  municipalWithholdings MunicipalWithholding[]
  casheaTransactions CasheaTransaction[]
  bankAccounts     BankAccount[]
  reconciliations  Reconciliation[]
  onlineOrders     OnlineOrder[]
  
  @@index([rif])

}

model User {
  id            String    @id @default(cuid())
  companyId     String
  email         String    @unique
  name          String
  password      String
  role          String    @default("USER") // ADMIN, ACCOUNTANT, CASHIER, USER, VIEWER
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  company       Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Activity tracking
  cashRegisters    CashRegister[]
  cashTransactions CashTransaction[]
  sales            Sale[]
  purchases        Purchase[]
  
  @@index([companyId])
  @@index([email])
}

// UserRole values: ADMIN, ACCOUNTANT, CASHIER, USER, VIEWER

// ============================================
// CUSTOMERS & VENDORS
// ============================================

model Customer {
  id          String   @id @default(cuid())
  companyId   String
  name        String
  rif         String
  address     String?
  phone       String?
  email       String?
  
  isSpecialTaxpayer Boolean @default(false)
  
  creditLimit Float?   @default(0)
  balance     Float    @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sales       Sale[]
  
  @@index([companyId])
  @@index([rif])
}

model Vendor {
  id          String   @id @default(cuid())
  companyId   String
  name        String
  rif         String
  address     String?
  phone       String?
  email       String?
  
  isSpecialTaxpayer Boolean @default(false)
  withholdingAgent Boolean @default(false)
  
  balance     Float    @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  purchases   Purchase[]
  
  @@index([companyId])
  @@index([rif])
}

// ============================================
// PRODUCTS (INVENTORY)
// ============================================

model Product {
  id          String   @id @default(cuid())
  companyId   String
  
  sku         String
  name        String
  description String?
  category    String?
  
  // Dual Currency Pricing
  priceUSD    Float
  priceBS     Float
  costUSD     Float?   @default(0)
  costBS      Float?   @default(0)
  
  // Stock
  stock       Int      @default(0)
  minStock    Int      @default(5)
  
  isActive    Boolean  @default(true)
  image       String?  // Product image URL or path
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  saleItems   SaleItem[]
  purchaseItems PurchaseItem[]
  onlineOrderItems OnlineOrderItem[]
  
  @@unique([companyId, sku])
  @@index([companyId])
  @@index([sku])
  @@index([category])
}

// ============================================
// PAYMENT METHODS
// ============================================

model PaymentMethod {
  id          String   @id @default(cuid())
  companyId   String
  name        String
  type        String // CASH, BANK_TRANSFER, DEBIT_CARD, CREDIT_CARD, CHECK, MOBILE_PAYMENT, OTHER, DIGITAL_TRANSFER, CRYPTO
  currency    String @default("USD") // "USD" o "BS"
  isActive    Boolean  @default(true)
  
  bankAccountId String?
  bankAccount   BankAccount? @relation(fields: [bankAccountId], references: [id])
  
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  cashTransactions CashTransaction[]
  sales         Sale[]
  salePayments SalePayment[]
  purchasePayments PurchasePayment[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([companyId])
  @@index([currency])

}

// PaymentType values: CASH, BANK_TRANSFER, DEBIT_CARD, CREDIT_CARD, CHECK, MOBILE_PAYMENT, OTHER

model BankAccount {
  id          String   @id @default(cuid())
  companyId   String
  bankName    String
  accountNumber String
  accountType String
  currency    String   @default("VES")
  balance     Float    @default(0)
  
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  paymentMethods   PaymentMethod[]
  reconciliations  Reconciliation[]
  
  @@index([companyId])
}

// ============================================
// CASH REGISTER (CAJA)
// ============================================

model CashRegister {
  id          String   @id @default(cuid())
  companyId   String
  userId      String
  
  // Balances USD
  openingBalanceUSD Float  @default(0)
  closingBalanceUSD Float?
  expectedBalanceUSD Float @default(0)
  differenceUSD      Float?
  
  // Balances Bs
  openingBalanceBS  Float  @default(0)
  closingBalanceBS  Float?
  expectedBalanceBS Float @default(0)
  differenceBS      Float?
  
  // Tasa BCV al momento de apertura
  bcvRate     Float
  
  openedAt    DateTime @default(now())
  closedAt    DateTime?
  notes       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id])
  transactions CashTransaction[]
  
  @@index([companyId])
  @@index([userId])
}

model CashTransaction {
  id              String   @id @default(cuid())
  cashRegisterId  String
  companyId       String
  userId          String
  
  type            String // OPENING, CASH_IN, CASH_OUT, SALE, EXPENSE, CLOSING
  amount          Float
  description     String
  reference       String?
  
  paymentMethodId String
  
  createdAt       DateTime @default(now())
  
  cashRegister    CashRegister @relation(fields: [cashRegisterId], references: [id])
  user            User @relation(fields: [userId], references: [id])
  paymentMethod   PaymentMethod @relation(fields: [paymentMethodId], references: [id])
  
  @@index([cashRegisterId])
  @@index([companyId])
  @@index([createdAt])
}

// CashTransactionType values: OPENING, CASH_IN, CASH_OUT, SALE, EXPENSE, CLOSING

// ============================================
// SALES (LIBRO DE VENTAS)
// ============================================

model Sale {
  id              String   @id @default(cuid())
  companyId       String
  customerId      String
  userId          String
  
  saleNumber      String   // VEN-00001
  invoiceNumber   String
  invoiceDate     DateTime
  
  // Dual Currency Totals
  subtotalUSD     Float
  subtotalBS      Float
  taxAmountUSD    Float    // IVA
  taxAmountBS     Float
  taxRate         Float    @default(16.0)
  totalUSD        Float
  totalBS         Float
  
  // Payment
  paymentMethodId String
  paymentStatus   String @default("PENDING") // PENDING, PARTIAL, PAID
  
  // BCV Rate used
  bcvRate         Float
  
  status          String @default("COMPLETED") // COMPLETED, CANCELLED
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer        Customer @relation(fields: [customerId], references: [id])
  user            User @relation(fields: [userId], references: [id])
  paymentMethod   PaymentMethod @relation(fields: [paymentMethodId], references: [id])
  
  items           SaleItem[]
  payments        SalePayment[]
  ivaWithholdings IVAWithholding[]
  islrWithholdings ISLRWithholding[]
  municipalWithholdings MunicipalWithholding[]
  casheaTransactions CasheaTransaction[]
  
  @@unique([companyId, saleNumber])
  @@unique([companyId, invoiceNumber])
  @@index([companyId])
  @@index([customerId])
  @@index([invoiceDate])
}

model SaleItem {
  id          String   @id @default(cuid())
  saleId      String
  productId   String?
  
  description String
  quantity    Float
  
  // Dual Currency
  unitPriceUSD Float
  unitPriceBS  Float
  subtotalUSD  Float
  subtotalBS   Float
  taxAmountUSD Float
  taxAmountBS  Float
  totalUSD     Float
  totalBS      Float
  
  sale        Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product     Product? @relation(fields: [productId], references: [id])
  
  @@index([saleId])
  @@index([productId])
}

model SalePayment {
  id              String   @id @default(cuid())
  saleId          String
  paymentMethodId String
  
  amount          Float
  paymentDate     DateTime
  reference       String?
  
  createdAt       DateTime @default(now())
  
  sale            Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)
  paymentMethod   PaymentMethod @relation(fields: [paymentMethodId], references: [id])
  
  @@index([saleId])
}

// ============================================
// PURCHASES (LIBRO DE COMPRAS)
// ============================================

model Purchase {
  id              String   @id @default(cuid())
  companyId       String
  vendorId        String
  userId          String
  
  invoiceNumber   String
  controlNumber   String?  // Número de control
  invoiceDate     DateTime
  
  subtotal        Float
  taxAmount       Float    // IVA
  taxRate         Float
  total           Float
  
  status          String @default("PENDING") // PENDING, PARTIALLY_PAID, PAID, CANCELLED, OVERDUE
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vendor          Vendor @relation(fields: [vendorId], references: [id])
  user            User @relation(fields: [userId], references: [id])
  
  items           PurchaseItem[]
  payments        PurchasePayment[]
  ivaWithholdings IVAWithholding[]
  
  @@unique([companyId, invoiceNumber, vendorId])
  @@index([companyId])
  @@index([vendorId])
  @@index([invoiceDate])
}

model PurchaseItem {
  id          String   @id @default(cuid())
  purchaseId  String
  productId   String
  
  description String
  quantity    Int
  unitPrice   Float
  subtotal    Float
  taxAmount   Float
  total       Float
  
  purchase    Purchase @relation(fields: [purchaseId], references: [id])
  product     Product  @relation(fields: [productId], references: [id])
  
  @@index([purchaseId])
  @@index([productId])
}

model PurchasePayment {
  id              String   @id @default(cuid())
  purchaseId      String
  paymentMethodId String
  
  amount          Float
  paymentDate     DateTime
  reference       String?
  
  createdAt       DateTime @default(now())
  
  purchase        Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  paymentMethod   PaymentMethod @relation(fields: [paymentMethodId], references: [id])
  
  @@index([purchaseId])
}

// InvoiceStatus values: PENDING, PARTIALLY_PAID, PAID, CANCELLED, OVERDUE

// ============================================
// TAX WITHHOLDINGS
// ============================================

model IVAWithholding {
  id              String   @id @default(cuid())
  companyId       String
  
  receiptNumber   String   // Número de comprobante
  receiptDate     DateTime
  
  // Reference to sale or purchase
  saleId          String?
  purchaseId      String?
  
  baseAmount      Float    // Base imponible
  withholdingRate Float    // Porcentaje de retención
  withholdingAmount Float
  
  status          String @default("PENDING") // PENDING, REPORTED, PAID, CANCELLED
  
  // File exports
  txtGenerated    Boolean  @default(false)
  xmlGenerated    Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sale            Sale? @relation(fields: [saleId], references: [id])
  purchase        Purchase? @relation(fields: [purchaseId], references: [id])
  
  @@unique([companyId, receiptNumber])
  @@index([companyId])
  @@index([receiptDate])
}

model ISLRWithholding {
  id              String   @id @default(cuid())
  companyId       String
  saleId          String?
  
  receiptNumber   String
  receiptDate     DateTime
  
  beneficiaryName String
  beneficiaryRif  String
  
  concept         String
  baseAmount      Float
  withholdingRate Float
  withholdingAmount Float
  
  status          String @default("PENDING")
  
  txtGenerated    Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sale            Sale?    @relation(fields: [saleId], references: [id])
  
  @@unique([companyId, receiptNumber])
  @@index([companyId])
  @@index([saleId])
  @@index([receiptDate])
}

model MunicipalWithholding {
  id              String   @id @default(cuid())
  companyId       String
  saleId          String?
  
  receiptNumber   String
  receiptDate     DateTime
  
  municipality    String
  beneficiaryName String
  beneficiaryRif  String
  
  concept         String
  baseAmount      Float
  withholdingRate Float
  withholdingAmount Float
  
  status          String @default("PENDING") // PENDING, REPORTED, PAID, CANCELLED
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sale            Sale?    @relation(fields: [saleId], references: [id])
  
  @@unique([companyId, receiptNumber])
  @@index([companyId])
  @@index([saleId])
  @@index([receiptDate])
}

// WithholdingStatus values: PENDING, REPORTED, PAID, CANCELLED

// ============================================
// RECONCILIATIONS
// ============================================

model Reconciliation {
  id              String   @id @default(cuid())
  companyId       String
  bankAccountId   String
  
  periodStart     DateTime
  periodEnd       DateTime
  
  bankBalance     Float
  bookBalance     Float
  difference      Float
  
  status          String @default("IN_PROGRESS") // IN_PROGRESS, COMPLETED, REVIEWED
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  bankAccount     BankAccount @relation(fields: [bankAccountId], references: [id])
  
  @@index([companyId])
  @@index([bankAccountId])
}

// ReconciliationStatus values: IN_PROGRESS, COMPLETED, REVIEWED

// ============================================
// E-COMMERCE ONLINE STORE
// ============================================


model OnlineOrder {
  id              String   @id @default(cuid())
  companyId       String
  orderNumber     String   @unique
  
  customerName    String
  customerEmail   String
  customerPhone   String
  customerRif     String?
  
  shippingAddress String
  shippingCity    String
  shippingState   String
  shippingZip     String?
  
  subtotal        Float
  shipping        Float
  tax             Float
  total           Float
  
  currency        String   @default("USD")
  bcvRate         Float?
  
  paymentMethod   String
  paymentStatus   String   @default("pending")
  casheaPaymentId String?
  
  orderStatus     String   @default("pending")
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  company         Company  @relation(fields: [companyId], references: [id])
  items           OnlineOrderItem[]
  
  @@index([companyId])
  @@index([orderNumber])
  @@index([customerEmail])
  @@index([orderStatus])
}

model OnlineOrderItem {
  id          String  @id @default(cuid())
  orderId     String
  productId   String
  
  description String
  sku         String?
  quantity    Int
  unitPrice   Float
  subtotal    Float
  
  order       OnlineOrder @relation(fields: [orderId], references: [id])
  product     Product     @relation(fields: [productId], references: [id])
  
  @@index([orderId])
  @@index([productId])
}

// ============================================
// CASHEA TRANSACTIONS
// ============================================

model CasheaTransaction {
  id            String   @id @default(cuid())
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id])
  
  saleId        String?
  sale          Sale?    @relation(fields: [saleId], references: [id])
  
  paymentId     String   @unique
  reference     String
  amount        Float
  currency      String   @default("USD")
  status        String   @default("pending")
  
  paymentUrl    String?
  qrCode        String?
  
  commission    Float?
  netAmount     Float?
  
  paidAt        DateTime?
  expiresAt     DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([companyId])
  @@index([saleId])
  @@index([paymentId])
  @@index([status])
}
